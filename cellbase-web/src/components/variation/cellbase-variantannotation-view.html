<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../shared/cellbase-shared-styles.html">

<dom-module id="cellbase-variantannotation-view">
    <template>
        <style is="custom-style" include="cellbase-shared-styles"></style>
        <div>
            <ul id="myTabs" class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#{{prefix}}variantAnnotationConsequenceTypes" role="tab" data-toggle="tab">Consequence Types</a></li>
                <li role="presentation"><a href="#{{prefix}}variantAnnotationPopulationFrequencies" role="tab" data-toggle="tab">Population Frequencies</a></li>
                <li role="presentation"><a href="#{{prefix}}variantAnnotationClinical" role="tab" data-toggle="tab">Gene Trait Association</a></li>
                <li role="presentation"><a href="#{{prefix}}variantAnnotationConservation" role="tab" data-toggle="tab">Conservation</a></li>
                <li role="presentation"><a href="#{{prefix}}variantAnnotationCadd" role="tab" data-toggle="tab">CADD</a></li>
            </ul>

            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="{{prefix}}variantAnnotationConsequenceTypes">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Gene</th>
                            <th>Ensembl Gene</th>
                            <th>Ensembl Transcript</th>
                            <th>Biotype</th>
                            <th>SO term</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{variantAnnotation.consequenceTypes}}" as="ct">
                            <tr>
                                <td>{{ct.geneName}}</td>
                                <td>{{ct.ensemblGeneId}}</td>
                                <td>{{ct.ensemblTranscriptId}}</td>
                                <td>{{ct.biotype}}</td>
                                <td>
                                    <template is="dom-repeat" items="{{ct.sequenceOntologyTerms}}">
                                        {{item.name}} ({{item.accession}})<br>
                                    </template>
                                </td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>

                <div role="tabpanel" class="tab-pane" id="{{prefix}}variantAnnotationPopulationFrequencies">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Study</th>
                            <th>Population</th>
                            <th>RefAllele</th>
                            <th>AltAllele</th>
                            <th>RefAlleleFreq</th>
                            <th>AltAlleleFreq</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{variantAnnotation.populationFrequencies}}">
                            <tr>
                                <td>{{item.study}}</td>
                                <td>{{item.population}}</td>
                                <td>{{item.refAllele}}</td>
                                <td>{{item.altAllele}}</td>
                                <td>{{item.refAlleleFreq}}</td>
                                <td>{{item.altAlleleFreq}}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                    <div id="container"></div>
                </div>

                <div role="tabpanel" class="tab-pane" id="{{prefix}}variantAnnotationClinical">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>HPO</th>
                            <th>Source</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{variantAnnotation.geneTraitAssociation}}">
                            <tr>
                                <td>{{item.id}}</td>
                                <td>{{item.name}}</td>
                                <td>{{item.score}}</td>
                                <td>{{item.hpo}}</td>
                                <td>{{item.source}}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>

                <div role="tabpanel" class="tab-pane" id="{{prefix}}variantAnnotationConservation">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Source</th>
                            <th>Score</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{variantAnnotation.conservation}}">
                            <tr>
                                <td>{{item.source}}</td>
                                <td>{{item.score}}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>

                <div role="tabpanel" class="tab-pane" id="{{prefix}}variantAnnotationCadd">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Source</th>
                            <th>Score</th>
                        </tr>
                        </thead>
                        <tbody>
                        <template is="dom-repeat" items="{{variantAnnotation.functionalScore}}">
                            <tr>
                                <td>{{item.source}}</td>
                                <td>{{item.score}}</td>
                            </tr>
                        </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'cellbase-variantannotation-view',

            properties: {
                data: {
                    type: String,
                    observer: '_variantChanged'
                },
                variantAnnotation: {
                    type: String
                },
                prefix: {
                    type: String
                }
            },
            ready: function() {
                this.cellBaseClient = CELLBASE_CLIENT;
            },
            _variantChanged: function() {
                let _this = this;
                var success = function (response) {
                    console.log(response)
                    _this.variantAnnotation = response.response[0].result[0];

                    let popArray = [];
                    let mafArray = [];
                    for (let i = 0; i < _this.variantAnnotation.populationFrequencies.length; i++) {
                        popArray.push(_this.variantAnnotation.populationFrequencies[i].study + "-" + _this.variantAnnotation.populationFrequencies[i].population);
                        mafArray.push(Math.min(_this.variantAnnotation.populationFrequencies[i].refAlleleFreq, _this.variantAnnotation.populationFrequencies[i].altAlleleFreq))
                    }
                    console.log(mafArray)

                    $('#container').highcharts({
                        chart: {
                            type: 'bar'
                        },
                        title: {
                            text: 'Population Frequencies'
                        },
                        xAxis: {
                            categories: popArray,
                            title: {
                                text: null
                            }
                        },
                        yAxis: {
                            min: 0,
                            title: {
                                text: 'Minor Allele Frequency (MAF)',
                                align: 'high'
                            },
                            labels: {
                                overflow: 'justify'
                            },
                            max: 0.5
                        },
//                        tooltip: {
//                            valueSuffix: ' millions'
//                        },
                        plotOptions: {
                            bar: {
                                dataLabels: {
                                    enabled: true
                                }
                            }
                        },
                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'top',
                            x: -40,
                            y: 80,
                            floating: true,
                            borderWidth: 1,
                            backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'),
                            shadow: true
                        },
                        credits: {
                            enabled: false
                        },
                        series: [{
                            name: 'Minor Allele Frequency (MAF)',
                            data: mafArray
                        }]
                    });

                };
                this.cellBaseClient.get('genomic', 'variant', this.data, 'annotation', {}, {success: success, async: true});
            }
        });
    </script>
</dom-module>
